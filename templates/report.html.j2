<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<style>
  /* ── Reset ── */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  /* ── Page setup ── */
  @page {
    size: {{ ds.page.width_mm }}mm {{ ds.page.height_mm }}mm;
    margin: {{ ds.page.margin_top_mm }}mm
            {{ ds.page.margin_right_mm }}mm
            {{ ds.page.margin_bottom_mm }}mm
            {{ ds.page.margin_left_mm }}mm;
  }

  body {
    font-family: "{{ ds.typography.body.font }}", Arial, sans-serif;
    font-size: {{ ds.typography.body.size_pt }}pt;
    color: {{ ds.colors.text }};
  }

  /* ── Page container ── */
  .page {
    width: {{ ds.page.content_width_mm }}mm;
    min-height: {{ ds.page.content_height_mm }}mm;
    page-break-after: always;
    display: flex;
    flex-direction: column;
  }
  .page:last-child { page-break-after: avoid; }

  /* ── Cover ── */
  .page--cover {
    background-color: #ffffff;
    color: {{ ds.colors.text }};
    padding: 10mm;
    justify-content: flex-start;
    border: 2mm solid {{ ds.colors.accent }};
  }
  .cover-top {
    display: flex;
    justify-content: flex-end;
    align-items: flex-start;
    min-height: 20mm;
  }
  .cover-logo {
    max-height: 22mm;
    max-width: 55mm;
  }
  .cover-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-start;
    padding: 8mm 0;
  }
  .cover-eyebrow {
    font-size: {{ ds.typography.caption.size_pt }}pt;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: {{ ds.colors.accent }};
    margin-bottom: 4mm;
  }
  .cover-title {
    font-size: {{ (ds.typography.heading.size_pt * 1.6) | round(1) }}pt;
    font-weight: bold;
    color: {{ ds.colors.primary }};
    line-height: 1.15;
    margin-bottom: 4mm;
  }
  .cover-subtitle {
    font-size: {{ (ds.typography.body.size_pt * 1.2) | round(1) }}pt;
    color: {{ ds.colors.text }};
    line-height: 1.5;
    margin-bottom: 3mm;
  }
  .cover-meta {
    font-size: {{ ds.typography.body.size_pt }}pt;
    color: {{ ds.colors.caption }};
    margin-top: 1.5mm;
  }

  /* ── Section divider ── */
  .page--section-divider {
    justify-content: flex-start;
  }
  .section-divider-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .section-divider-label {
    font-size: {{ ds.typography.caption.size_pt }}pt;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: {{ ds.colors.caption }};
    margin-bottom: 3mm;
  }
  .section-divider-title {
    font-size: {{ (ds.typography.heading.size_pt * 1.8) | round(1) }}pt;
    font-weight: bold;
    color: {{ ds.colors.primary }};
    line-height: 1.15;
    border-left: 2mm solid {{ ds.colors.accent }};
    padding-left: 5mm;
  }

  /* ── Content page ── */
  .page--content {
    gap: 4mm;
  }
  .content-heading {
    font-size: {{ ds.typography.heading.size_pt }}pt;
    font-weight: bold;
    color: {{ ds.colors.primary }};
    margin-bottom: 2mm;
    line-height: 1.2;
  }

  /* ── Photo grid ── */
  .photo-grid {
    display: flex;
    gap: 3mm;
    flex: 1;
    align-items: flex-start;
  }
  .photo-cell {
    display: flex;
    flex-direction: column;
    gap: 1mm;
  }
  /* Layout variants */
  .photo-cell--full-width {
    width: 100%;
  }
  .photo-cell--half-width {
    width: calc(50% - 1.5mm);
  }
  .photo-cell--portrait-pair {
    width: 60%;
    margin: 0 auto;
  }
  /* Single portrait — center in grid */
  .photo-grid--single-portrait {
    justify-content: center;
  }
  /* Two landscape photos stacked vertically */
  .photo-grid--stacked {
    flex-direction: column;
    gap: 4mm;
  }
  .photo-grid--stacked .photo-cell {
    width: 100%;
  }
  .photo-grid--stacked .photo-cell {
    flex: 1;
  }
  .photo-grid--stacked .photo-img {
    width: 100%;
    height: auto;
    max-height: {{ (ds.page.content_height_mm / 2.2) | round(1) }}mm;
    object-fit: contain;
  }

  .photo-img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: contain;
  }
  .photo-subtitle {
    font-size: {{ ds.typography.caption.size_pt }}pt;
    font-weight: bold;
    color: {{ ds.colors.primary }};
    margin-top: 1.5mm;
    letter-spacing: 0.02em;
  }
  .photo-caption {
    font-size: {{ ds.typography.caption.size_pt }}pt;
    color: {{ ds.colors.caption }};
    line-height: 1.3;
  }

  /* ── Text-only / appendix content ── */
  .text-only-body {
    font-size: {{ ds.typography.body.size_pt }}pt;
    color: {{ ds.colors.text }};
    line-height: 1.6;
    flex: 1;
  }
  /* Markdown elements inside text blocks */
  .text-only-body h2 {
    font-size: {{ (ds.typography.body.size_pt * 1.3) | round(1) }}pt;
    font-weight: bold;
    color: {{ ds.colors.primary }};
    margin-top: 4mm;
    margin-bottom: 1.5mm;
  }
  .text-only-body h3 {
    font-size: {{ ds.typography.body.size_pt }}pt;
    font-weight: bold;
    margin-top: 3mm;
    margin-bottom: 1mm;
  }
  .text-only-body ul, .text-only-body ol {
    padding-left: 5mm;
    margin-bottom: 2mm;
  }
  .text-only-body li {
    margin-bottom: 0.5mm;
  }
  .text-only-body p {
    margin-bottom: 2mm;
  }
  .text-only-body strong { font-weight: bold; }
  .text-only-body em { font-style: italic; }
  .text-only-body hr {
    border: none;
    border-top: 0.2mm solid {{ ds.colors.accent }};
    margin: 3mm 0;
  }

  /* ── Running header (non-cover pages) ── */
  .page-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    padding-bottom: 2mm;
    margin-bottom: 3mm;
    border-bottom: 0.3mm solid {{ ds.colors.accent }};
    flex-shrink: 0;
  }
  .page-header-title {
    font-size: {{ ds.typography.caption.size_pt }}pt;
    color: {{ ds.colors.accent }};
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  .page-header-section {
    font-size: {{ ds.typography.caption.size_pt }}pt;
    color: {{ ds.colors.caption }};
  }

  /* ── Footer (all pages) ── */
  .page-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: auto;
    padding-top: 2mm;
    border-top: 0.3mm solid {{ ds.colors.accent }};
    flex-shrink: 0;
    height: 8mm;
  }
  .page-footer-number {
    font-size: {{ ds.typography.caption.size_pt }}pt;
    color: {{ ds.colors.caption }};
  }
  .page-footer-logo {
    max-height: 7mm;
    max-width: 35mm;
  }
</style>
</head>
<body>

{% for page in pages %}
{% set p = page %}

{# ── COVER ── #}
{% if p.page_type == "cover" %}
<div class="page page--cover">
  {# Top bar: logo right-aligned #}
  <div class="cover-top">
    {% if logo_src %}
    <img class="cover-logo" src="{{ logo_src }}" alt="Logo">
    {% elif footer_logo_src %}
    <img class="cover-logo" src="{{ footer_logo_src }}" alt="Logo">
    {% endif %}
  </div>
  {# Main body: title + meta vertically centered #}
  <div class="cover-body">
    <div class="cover-eyebrow">Fotoprotokoll</div>
    {% set ns = namespace(subtitle_shown=false) %}
    {% for block in p.text_blocks %}
      {% if block.role == "heading" %}
      <div class="cover-title">{{ block.content }}</div>
      {% elif not ns.subtitle_shown %}
      <div class="cover-subtitle">{{ block.content }}</div>
      {% set ns.subtitle_shown = true %}
      {% else %}
      <div class="cover-meta">{{ block.content }}</div>
      {% endif %}
    {% endfor %}
  </div>
</div>

{# ── SECTION DIVIDER ── #}
{% elif p.page_type == "section_divider" %}
<div class="page page--section-divider">
  <div class="page-header">
    {% if p.page_heading %}<span class="page-header-title">{{ p.page_heading }}</span>{% endif %}
  </div>
  {# Large title vertically centered in remaining space #}
  <div class="section-divider-body">
    <div class="section-divider-label">Abschnitt</div>
    {% for block in p.text_blocks %}
    <div class="section-divider-title">{{ block.content }}</div>
    {% endfor %}
  </div>
  <div class="page-footer">
    <span class="page-footer-number">{{ p.page_number }}</span>
    {% if footer_logo_src %}<img class="page-footer-logo" src="{{ footer_logo_src }}" alt="Logo">{% endif %}
  </div>
</div>

{# ── CONTENT ── #}
{% elif p.page_type == "content" %}
<div class="page page--content">
  <div class="page-header">
    {% if p.page_heading %}<span class="page-header-title">{{ p.page_heading }}</span>{% endif %}
  </div>
  {% for block in p.text_blocks %}
    {% if block.role == "heading" %}
    <div class="content-heading">{{ block.content }}</div>
    {% else %}
    <div class="text-only-body">{{ block.content | markdown }}</div>
    {% endif %}
  {% endfor %}

  {% if p.layout_variant == "text-only" %}
    {# heading already rendered above, nothing more to add #}
  {% else %}
  {% set is_single_portrait = (p.photo_slots | length == 1 and p.photo_slots[0].display_size == "portrait-pair") %}
  {% set is_stacked = (p.photo_slots | length > 1) and (p.photo_slots | selectattr("display_size", "equalto", "full-width") | list | length > 0) %}
  <div class="photo-grid{% if is_single_portrait %} photo-grid--single-portrait{% elif is_stacked %} photo-grid--stacked{% endif %}">
    {% for slot in p.photo_slots %}
    {% set src = photo_srcs.get(slot.photo_id, "") %}
    <div class="photo-cell photo-cell--{{ 'full-width' if is_stacked else slot.display_size }}">
      {% if src %}
      <img class="photo-img" src="{{ src }}" alt="{{ slot.caption }}">
      {% endif %}
      {% if slot.subtitle %}
      <div class="photo-subtitle">{{ slot.subtitle }}</div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}
  <div class="page-footer">
    <span class="page-footer-number">{{ p.page_number }}</span>
    {% if footer_logo_src %}<img class="page-footer-logo" src="{{ footer_logo_src }}" alt="Logo">{% endif %}
  </div>
</div>

{% endif %}
{% endfor %}

</body>
</html>
